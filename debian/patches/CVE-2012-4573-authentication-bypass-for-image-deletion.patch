Description: Authentication bypass for image deletion
 Gabe Westmaas from Rackspace reported a vulnerability in Glance
 authentication of image deletion requests. Authenticated users may be
 able to delete arbitrary, non-protected images from Glance servers. Only
 Folsom/Grizzly deployments that expose the v1 API are affected by this
 vulnerability. Additionally, Essex deployments that use the
 delayed_delete option are also affected.
Author: Gabe Westmaas (Rackspace)
Bug-Debian: http://bugs.debian.org/692641
Origin: upstream

--- glance-2012.1.1.orig/glance/api/v1/images.py
+++ glance-2012.1.1/glance/api/v1/images.py
@@ -731,10 +731,10 @@ class Controller(controller.BaseControll
         # to delete the image if the backend doesn't yet store it.
         # See https://bugs.launchpad.net/glance/+bug/747799
         try:
+            registry.delete_image_metadata(req.context, id)
             if image['location']:
                 schedule_delete_from_backend(image['location'], self.conf,
                                              req.context, id)
-            registry.delete_image_metadata(req.context, id)
         except exception.NotFound, e:
             msg = ("Failed to find image to delete: %(e)s" % locals())
             for line in msg.split('\n'):
