Description: Backend credentials leak in Glance v1 API
 Stuart McLaren from HP reported a vulnerability in the information
 potentially returned to the user in Glance v1 API. If an authenticated
 user requests, through the v1 API, an image that is already cached, the
 headers returned may disclose the Glance operator's backend credentials
 for that endpoint. Only setups accepting the Glance v1 API and using
 either the single-tenant Swift store or S3 store are affected.
Author: Stuart McLaren <stuart.mclaren@hp.com>
Origin: upstream
Bug-Debian: http://bugs.debian.org/703063
Bug-Ubuntu: https://launchpad.net/glance/+bug/1135541

diff --git a/glance/api/middleware/cache.py b/glance/api/middleware/cache.py
index 8e24ef0..dcd59b6 100644
--- a/glance/api/middleware/cache.py
+++ b/glance/api/middleware/cache.py
@@ -111,6 +111,9 @@ class CacheFilter(wsgi.Middleware):
 
     def _process_v1_request(self, request, image_id, image_iterator):
         image_meta = registry.get_image_metadata(request.context, image_id)
+        # Don't display location
+        if 'location' in image_meta:
+            del image_meta['location']
 
         if not image_meta['size']:
             # override image size metadata with the actual cached
