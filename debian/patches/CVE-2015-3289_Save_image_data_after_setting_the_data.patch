Description: CVE-2015-3289: Save image data after setting the data
 The image's locations are missing when image's are imported using tasks
 because the ImportToStore task is not saving the image metadata after the
 import. This patch fixes that.
Author: Flavio Percoco <flaper87@gmail.com>
Date: Fri, 8 May 2015 09:44:14 +0000 (+0200)
X-Git-Url: https://review.openstack.org/gitweb?p=openstack%2Fglance.git;a=commitdiff_plain;h=88f92eb11d556bf43e2800a05973ad2da0db0195
Change-Id: I43dec450d5fc4bee2131d78dbe3c2b2373c3f739
Bug-Ubuntu: https://bugs.launchpad.net/glance/+bug/1453068
Origin: https://review.openstack.org/#/c/181816/
Last-Update: 2015-07-28

diff --git a/glance/async/flows/base_import.py b/glance/async/flows/base_import.py
index 487247c..7656bde 100644
--- a/glance/async/flows/base_import.py
+++ b/glance/async/flows/base_import.py
@@ -283,6 +283,10 @@ class _ImportToStore(task.Task):
 
         image_import.set_image_data(image, file_path or self.uri, None)
 
+        # NOTE(flaper87): We need to save the image again after the locations
+        # have been set in the image.
+        self.image_repo.save(image)
+
 
 class _SaveImage(task.Task):
 
diff --git a/glance/tests/unit/async/flows/test_import.py b/glance/tests/unit/async/flows/test_import.py
index 0f355bc..7acd599 100644
--- a/glance/tests/unit/async/flows/test_import.py
+++ b/glance/tests/unit/async/flows/test_import.py
@@ -112,6 +112,10 @@ class TestImportTask(test_utils.BaseTestCase):
                                           "%s.tasks_import" % image_path)
             self.assertFalse(os.path.exists(tmp_image_path))
             self.assertTrue(os.path.exists(image_path))
+            self.assertEqual(1, len(list(self.image.locations)))
+            self.assertEqual("file://%s/%s" % (self.test_dir,
+                                               self.image.image_id),
+                             self.image.locations[0]['url'])
 
     def test_import_flow_missing_work_dir(self):
         self.config(engine_mode='serial', group='taskflow_executor')
